#! /bin/sh
# -----------------------------------------------------------------------------
#     Title: A script to invoke the various CL implementations in a uniform way
#   Created: 1999-01-16 16:41
#    Author: Gilbert Baumann <unk6@rz.uni-karlsruhe.de>
#   License: LGPL (See file COPYING for details)
# -----------------------------------------------------------------------------
#  (c) copyright 1999 by Gilbert Baumann

# Prior to invocation the LISPTYPE environment variable must been set to
# one of these:
#
#    clisp      
#    cmucl
#    acl43
#    acl5
#    gcl

usage(){
    cat <<EOF
INVOCATION

 run-lisp [clause ...] [argument ...]
     clause ::= -i file    ; load file \`file'
              | -c file    ; compile file \`file'
              | -x form    ; execute form \`form'
              | -I image   ; use image file \`image'
              | -d image   ; dump to image \`image'
              | --safety n ; set safety level for compilation
              | --speed n  ; set speed level for compilation

     Note: Lisp specific extensions (e.g. .dxl on ACL or .mem for CLISP)
           are not to be included into the image argument

     Anything else is stuffed into the Lisp variable 'argv', which is
     available in the lexical environment forms given to -x are
     evaluated in.

 run-lisp -run image
   interactively run \`image'
   (user:run will be called upon start up).

Makefile support

 run-lisp -faslext
   echo the fasload file extension to stdout.
   This is useful for Makefile; you could then say e.g.
   FAS:=$(shell (export LISPTYPE=$(LISPTYPE) ; $(TOP)/bin/run-lisp -faslext))

 run-lisp -dumpext
   echo the memory image extension _with_ dot.
   usage: (like above)
   DUMP:=$(shell (export LISPTYPE=$(LISPTYPE) ; $(TOP)/bin/run-lisp -dumpext))

 run-lisp -cat [fasl-file ...]
   Cat all the given fasl files together.

EXAMPLE

   $ bin/run-lisp -x "(print argv)" foo bar baz "Hallo Welt" foo\"bar
   ("foo" "bar" "baz" "Hallo Welt" "foo\"bar")
   $
EOF
    exit 0;
}

fail(){ echo "$0: $*" 1>&2; exit 1; }

case "$1" in
  "--help" | "-h" | "-?" )
      usage
      ;;
  "-cat" )
      shift
      case "$LISPTYPE" in
        clisp | cmucl | acl43 | acl5 )
            cat "$@"
            ;;
        * )
            fail "Sorry, option -cat not supported for LISPTYPE=${LISPTYPE}."
            ;;
      esac
      ;;
  "-faslext" )
      shift
      case "$LISPTYPE" in
        clisp )
            # This is (pathname-type (car (system::*compiled-file-types*))).
            echo 'fas'
            ;;
        cmucl )
            # This can be found via (c:backend-fasl-file-type c:*target-backend*),
            # but for speed we look at the uname first.
            case $(uname -m 2>/dev/null) in
                i[3-6]86 )
                   echo .x86f
                   ;;
                * )
                  # Call .
                  ${CMUCL-lisp} -noinit \
                         -eval "(progn \
                                  (write-string (c:backend-fasl-file-type c:*target-backend*)) \
                                  (terpri)
                                  (ext:quit 0))"
                         -batch </dev/null
                  ;;
            esac
            ;;
        acl43 | acl5 )
            echo 'fasl'
            ;;
        gcl )
            echo 'o' # but also 'data' on same platforms
            ;;
        * )
            # Since make does not stop when the exit status is 1, we simply
            # echo LISPTYPE_NOT_SET here.
            fail "Sorry, option -faslext not supported for LISPTYPE=${LISPTYPE}."
            echo LISPTYPE_NOT_SET
            exit 1
            ;;
      esac
      ;;
  "-dumpext" )
      shift 1
      case $LISPTYPE in
          clisp)
              echo .mem
          ;;
          acl43)
              echo ""
          ;;
          acl5)
              echo .dxl
          ;;
          cmucl)
              echo .core
          ;;
          *)
              # same as above
              fail "Sorry, option -dumpext not supported for LISPTYPE=${LISPTYPE}."
              echo LISPTYPE_NOT_SET
              exit 1
          ;;
      esac
    ;;
  "-run" )
    # we special case on '-run' for now
    shift 1
    case $LISPTYPE in
        clisp)
            ${CLISP-clisp} -M $1.mem -x '(run)'
        ;; 
        cmucl )
            ${CMUCL-lisp} -core "$1".core -eval '(run)'
            ;;
        acl43 )
            # Why "$1"? ACL4.3 dumps executables
            "$1" -e '(unwind-protect (run) (excl:exit))'
            ;;
        acl5 )
            ${ACL5-cl} -I "$1".dxl -e '(unwind-protect (run) (excl:exit))'
            ;;
        gcl )
            "$1" -eval '(run)'
            ;;
        *)
            fail "Sorry, option -run not supported for LISPTYPE=${LISPTYPE}."
        ;;
    esac
    ;;
  * )
    # Multiple arguments.
    unset image
    todo=""             # list of forms to execute
    args=""             # list of arguments (strings) to pass
    while [ $# != 0 ]; do
      case "$1" in
        -i)
            if [ $# = 1 ]; then
              fail "missing argument for $1"
              exit 1
            fi
            shift
            arg=`echo "$1" | sed -e 's,\(["\\]\),\\\\\1,g'`
            todo=$todo" (load \"${arg}\")"
            shift
            ;;
        -x)
            if [ $# = 1 ]; then
              fail "missing argument for $1"
            fi
            shift
            todo=$todo" $1"
            shift
            ;;
        -c)
            if [ $# = 1 ]; then
              fail "missing argument for $1"
            fi
            shift
            arg=`echo "$1" | sed -e 's,\(["\\]\),\\\\\1,g'`
            # todo=$todo" (compile-file \"${arg}\" :print nil)"
            # truename helps, when using Franz' emacs interface
            todo=$todo" (compile-file (truename \"${arg}\") :print nil)"
            shift
            ;;
        -I)
            if [ $# = 1 ]; then
              fail "missing argument for $1"
            fi
            shift
            image="$1"
            shift
            ;;
        -d)
            if [ $# = 1 ]; then
              fail "missing argument for $1"
            fi
            shift
            arg=`echo "$1" | sed -e 's,\(["\\]\),\\\\\1,g'`
            case "$LISPTYPE" in
              clisp )
                  todo=$todo" (lisp:saveinitmem \"${arg}.mem\")"
                  ;;
              cmucl )
                  todo=$todo" (save-lisp \"${arg}.core\")"
                  ;;
              acl43 )
                  todo=$todo" (excl:dumplisp :name \"${arg}\")"
                  ;;
              acl5 )
                  todo=$todo" (excl:dumplisp :name \"${arg}.dxl\")"
                  ;;
              gcl )
                  todo=$todo" (si:save-system \"${arg}\")"
                  ;;
              * )
                  fail "Sorry, option -d not supported for LISPTYPE=${LISPTYPE}."
                  exit 1
                  ;;
            esac
            shift
            ;;
        --safety)
            if [ $# = 1 ]; then
              fail "missing argument for $1"
              exit 1
            fi
            shift 1
            todo=$todo" (proclaim (quote (optimize (safety "$1"))))"
            shift 1
        ;;
        --speed)
            if [ $# = 1 ]; then
              fail "missing argument for $1"
              exit 1
            fi
            shift 1
            todo=$todo" (proclaim (quote (optimize (speed "$1"))))"
            shift 1
        ;;
        *)
            arg=`echo "$1" | sed -e 's,\(["\\]\),\\\\\1,g'`
            args=$args" \"${arg}\""
            shift
            ;;
      esac
    done

    # done with collecting the arguments

    todo="(progn${todo})"
    args="(${args})"
    todo="(let ((argv '$args)) (declare (ignorable argv)) $todo (values))"

    case "$LISPTYPE" in
      clisp )
          todo="(setq lisp:*load-paths* '(#P\"\")) "$todo
          echo "$todo" | exec ${CLISP-clisp} ${image+"-M ${image}.mem"} -
          ;;
      cmucl )
          # we have to convince CMUCL to return a proper exit status.
          todo="(let (.res (.cond t))
                  (unwind-protect
                    (multiple-value-setq (.res .cond)
                       (ignore-errors (progn $todo (fresh-line) (finish-output))))
                    (unix:unix-exit (if .cond 1 0))))"
          exec ${CMUCL-lisp} ${image+"-core ${image}.core"} -eval "$todo"
          ;;
      acl43 )
          echo "$todo" | exec ${image-${ACL43-cl}} -batch
          ;;
      acl5 )
          echo "$todo" | exec ${ACL5-cl} ${image+"-I ${image}.dxl"} -batch
          ;;
      gcl )
          echo "$todo" | exec ${image-${GCL-gcl}} -batch
          ;;
      * )
          if [ -n "$LISPTYPE" ] ; then
            fail "Sorry, LISPTYPE=${LISPTYPE} is not supported"
          else
            fail "LISPTYPE environment variable is not set"
          fi
          ;;
    esac

esac
