<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- This file is automatically generated, do not edit -->

<HTML LANG='en'>
  <HEAD>
    <TITLE>1.3.2 Displaying the Menu</TITLE>
    <LINK HREF='mailto:gilbert@ma2s2.mathematik.uni-karlsruhe.de' REV='made'>
    <LINK HREF='1_3_3_Menu_Input.html' REL='Next'>
    <LINK HREF='1_3_1_A_Simple_Menu.html' REL='Previous'>
    <LINK HREF='index.html' REL='Start'>
    <LINK HREF='contents.html' REL='Contents'>
    <LINK HREF='the_index.html' REL='Index'>
    <LINK HREF='Glossary.html' REL='Glossary'>
    <LINK HREF='Front_matter.html' REL='Copyright'>
  <BODY BGCOLOR='#FFFFFF'>
    <A HREF='1_3_3_Menu_Input.html'>Next</A> <A
     HREF='1_3_1_A_Simple_Menu.html'>Prev</A> <A
     HREF='1_3_A_Quick_Tour_of_CLX.html'>Up</A> 
    <HR>
    <H1><FONT FACE='helvetica' COLOR='#004000'>1.3.2 Displaying the Menu
      </FONT></H1>
     
    <P>
      The <CODE>menu-recompute-geometry</CODE> function (shown in the 
      following example) handles the job of calculating the size of the menu, 
      based on its current item list and its current text font. CLX provides 
      a way to inquire the geometrical properties of a font object (for 
      example, its ascent and descent from the baseline) and also a <A
       HREF='8_6_Querying_Text_Size.html#text-extents'><B>text-extents</B></A>
       function. <A HREF='8_6_Querying_Text_Size.html#text-extents'><B>
      text-extents</B></A> returns the geometry of a given string as 
      displayed in a given font. Notice the use of the <A
       HREF='4_3_Window_Attributes.html#with-state'><B>with-state</B></A> 
      macro when setting a window&#39;s geometry attributes. CLX strives to 
      preserve the familiar <B>setf</B> style of accessing individual window 
      attributes, even though an attribute access actually involves sending a 
      request to a (possibly remote) server and/or waiting for a reply. <A
       HREF='4_3_Window_Attributes.html#with-state'><B>with-state</B></A> 
      tells CLX to batch together all read and write accesses to a given 
      window, using a local cache to minimize the number of server requests. 
      This CLX feature can result in a dramatic improvement in client 
      performance without burdening the programmer interface.
    <P>
      <CODE>menu-recompute-geometry</CODE> causes all the item subwindows to 
      become <I>mapped</I>. Mapping a window means attempting to make it 
      visible on the screen. However, a subwindow will not actually be <I>
      visible</I> until it and all of its ancestors are mapped. Even then, 
      another window might be covering up the subwindow.
    <PRE>
(defun menu-recompute-geometry (menu)
  (when (menu-geometry-changed-p menu)
    (let* ((menu-font   (GCONTEXT-FONT (menu-gcontext menu)))
           (title-width (TEXT-EXTENTS menu-font (menu-title menu)))
           (item-height (+ (FONT-ASCENT menu-font)
                           (FONT-DESCENT menu-font)
                           *menu-item-margin*))
           (item-width     0)
           (items          (menu-item-alist menu))
           menu-width)

      ;; Find max item string width
      (setf item-width
            (+ *menu-item-margin*
               (dolist (next-item items item-width)
                 (setf item-width (max item-width
                                       (TEXT-EXTENTS menu-font (second next-item)))))))

      ;; Compute final menu width, taking margins into account
      (setf menu-width (max title-width (+ item-width *menu-item-margin*)))
      (let ((window     (menu-window menu)))

        ;; Update width and height of menu window
        (WITH-STATE (window)
                    (setf (DRAWABLE-WIDTH      window) menu-width
                          (DRAWABLE-HEIGHT window) (* (1+ (length items)) item-height)))

        ;; Update width, height, position of item         windows
        (let ((item-left         (round (- menu-width item-width) 2))
              (next-item-top (- item-height (round *menu-item-margin* 2))))
          (dolist (next-item items)
            (let ((window (first next-item)))
              (WITH-STATE (window)
                          (setf (DRAWABLE-HEIGHT window) item-height
                                (DRAWABLE-WIDTH      window) item-width
                                (DRAWABLE-X          window) item-left
                                (DRAWABLE-Y          window) next-item-top)))
            (incf next-item-top item-height))))

      ;; Map all item windows
      (MAP-SUBWINDOWS (menu-window menu))

      ;; Save item geometry
      (setf (menu-item-width menu)         item-width
            (menu-item-height menu)        item-height
            (menu-width menu)              menu-width
            (menu-title-width menu)        title-width
            (menu-geometry-changed-p menu) nil))))
        </PRE>
     
    <P>
      Of course, the sample client must know how to draw/redraw the menu and 
      its items, so the function <CODE>menu-refresh</CODE> is defined next to 
      handle that task (shown in the following example). Note that the 
      location of window output is given relative to the window origin. 
      Windows and subwindows have different coordinate systems. The location 
      of the origin (upper-left corner) of a subwindow&#39;s coordinate 
      system is given with respect to its parent window&#39;s coordinate 
      system. Negative coordinates are valid, although only output to the 
      +x/+y quadrant of a window&#39;s coordinate system will ever be visible.
    <PRE>
(defun menu-refresh (menu)
  (let* ((gcontext   (menu-gcontext menu))
         (baseline-y (FONT-ASCENT (GCONTEXT-FONT gcontext))))
    ;; Show title centered in &#34;reverse-video&#34;
    (let ((fg (GCONTEXT-BACKGROUND gcontext))
          (bg (GCONTEXT-FOREGROUND gcontext)))
      (WITH-GCONTEXT (gcontext :foreground fg :background bg)
                     (DRAW-IMAGE-GLYPHS
                      (menu-window menu)
                      gcontext
                      (round (- (menu-width menu)
                                (menu-title-width menu)) 2)     ;start x
                      baseline-y                                ;start y
                      (menu-title menu))))

    ;; Show each menu item (position is relative to item window)
    (let ((box-margin (round *menu-item-margin* 2)))
      (dolist (item (menu-item-alist menu))
        (DRAW-IMAGE-GLYPHS
         (first item) gcontext
         box-margin                                             ;start x
         (+ baseline-y box-margin)                              ;start y
         (second item))))))
        </PRE>
     
    <P>
      <A HREF='5_6_Graphics_Context_Cache.html#with-gcontext'><B>with-gcontext
      </B></A> is a CLX macro that allows you temporarily to modify a 
      graphics context within the dynamic scope of the macro body. <A
       HREF='6_7_Drawing_Text.html#draw-image-glyphs'><B>draw-image-glyphs</B>
      </A> is a CLX text drawing function which produces a terminal-like 
      rendering: foreground character on a background block. (More 
      sophisticated text rendering functions are also available.) The strange 
      use of <I>glyphs</I> instead of <I>string</I> here actually highlights 
      an important fact: X and Common Lisp have totally different concepts of 
      a character. A Common Lisp character is an object whose implementation 
      can comprehend a vast universe of text complexities (typefaces, type 
      styles, international character sets, symbols, and so forth). However, 
      to X, a string is just a sequence of integer indexes into the array of 
      bitmaps represented by a CLX font object. In general, <A
       HREF='6_7_Drawing_Text.html#draw-image-glyphs'><B>draw-image-glyphs</B>
      </A>, <A HREF='8_6_Querying_Text_Size.html#text-extents'><B>text-extents
      </B></A>, and other CLX text functions accept a <B>:translate</B> 
      keyword argument. Its value is a function which translates the 
      characters of a string argument into the appropriate font-and-index 
      pairs needed by CLX. This example relies upon the default translation 
      function, which simply uses <B>char-code</B> to compute an index into 
      the current font.
    
    <HR>
    <A HREF='1_3_3_Menu_Input.html'>Next</A> <A
     HREF='1_3_1_A_Simple_Menu.html'>Prev</A> <A
     HREF='1_3_A_Quick_Tour_of_CLX.html'>Up</A> 
    <HR>
    <A HREF='Front_matter.html'>&#169; 1988, 1989 Texas Instruments 
    Incorporated</A>
    <BR>
    Conversion to HTML made by <A
     HREF='mailto:gilbert@ma2s2.mathematik.uni-karlsruhe.de' LANG='de'>
    Gilbert Baumann</A>.
    <BR>
    Last build: Tue Dec 16 23:30:42 1997
